// api/create-pix.js - Vercel Serverless Function SEGURA
const { MercadoPagoConfig, Payment } = require('mercadopago');
const admin = require('firebase-admin');

// ‚úÖ CONFIGURA√á√ÉO SEGURA - Token via vari√°vel de ambiente
const accessToken = process.env.MERCADOPAGO_ACCESS_TOKEN;

if (!accessToken) {
    throw new Error('MERCADOPAGO_ACCESS_TOKEN n√£o est√° definido nas vari√°veis de ambiente.');
}

const client = new MercadoPagoConfig({
    accessToken: accessToken,
    options: {
        timeout: 10000
    }
});

const payment = new Payment(client);

// ‚úÖ INICIALIZAR FIREBASE ADMIN (PARA VERIFICA√á√ÉO DE AUTENTICA√á√ÉO)
function initializeFirebaseAdmin() {
    if (!admin.apps.length) {
        try {
            const serviceAccount = JSON.parse(process.env.FIREBASE_SERVICE_ACCOUNT_JSON);
            admin.initializeApp({
                credential: admin.credential.cert(serviceAccount),
                databaseURL: "https://shortcut-6256b-default-rtdb.firebaseio.com"
            });
        } catch (error) {
            console.error('Falha na inicializa√ß√£o do Firebase Admin SDK:', error);
        }
    }
    return admin;
}

// ‚úÖ VERIFICA√á√ÉO DE AUTENTICA√á√ÉO
async function verifyAuthToken(authHeader) {
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
        throw new Error('Token de autentica√ß√£o n√£o fornecido');
    }
    
    const idToken = authHeader.split('Bearer ')[1];
    const adminInstance = initializeFirebaseAdmin();
    
    try {
        const decodedToken = await adminInstance.auth().verifyIdToken(idToken);
        return decodedToken;
    } catch (error) {
        throw new Error('Token de autentica√ß√£o inv√°lido');
    }
}

// ‚úÖ DOM√çNIOS PERMITIDOS (CORS SEGURO)
const ALLOWED_ORIGINS = [
    'https://atalho.me',
    'https://www.atalho.me',
    'http://localhost:3000',
    'https://atalho.vercel.app'
];

// ‚úÖ RATE LIMITING SIMPLES
const requestCounts = new Map();

function checkRateLimit(ip) {
    const now = Date.now();
    const windowStart = Math.floor(now / (15 * 60 * 1000)) * (15 * 60 * 1000); // 15 min window
    const key = `${ip}-${windowStart}`;
    
    const count = requestCounts.get(key) || 0;
    if (count >= 10) { // M√°ximo 10 tentativas por 15 minutos
        return false;
    }
    
    requestCounts.set(key, count + 1);
    
    // Limpar entradas antigas
    for (const [k, v] of requestCounts.entries()) {
        if (k.split('-')[1] < windowStart - (15 * 60 * 1000)) {
            requestCounts.delete(k);
        }
    }
    
    return true;
}

// ‚úÖ VALIDA√á√ÉO DE EMAIL
function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email) && email.length <= 254;
}

// ‚úÖ DETEC√á√ÉO DE CONTE√öDO SUSPEITO
function containsSuspiciousContent(value) {
    if (typeof value !== 'string') return false;
    
    const suspiciousPatterns = [
        /<script/i,
        /javascript:/i,
        /on\w+\s*=/i,
        /eval\s*\(/i,
        /document\./i,
        /window\./i,
        /bitcoin|crypto|btc|eth/i
    ];
    
    return suspiciousPatterns.some(pattern => pattern.test(value));
}

// Fun√ß√£o para gerar CPF v√°lido para testes
function generateValidCPF() {
    return '11144477735';
}

// ‚úÖ GERA√á√ÉO DE CHAVE DE IDEMPOT√äNCIA SEGURA
function generateSecureIdempotencyKey() {
    const timestamp = Date.now();
    const random = Math.random().toString(36).substring(2, 15);
    return `atalho-${timestamp}-${random}`;
}

module.exports = async (req, res) => {
    try {
        // ‚úÖ CORS SEGURO - Apenas dom√≠nios permitidos
        const origin = req.headers.origin;
        if (origin && ALLOWED_ORIGINS.includes(origin)) {
            res.setHeader('Access-Control-Allow-Origin', origin);
        } else {
            res.setHeader('Access-Control-Allow-Origin', 'https://atalho.me');
        }
        
        res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
        res.setHeader('Access-Control-Allow-Headers', 'Content-Type, X-Requested-With');
        res.setHeader('Access-Control-Max-Age', '86400'); // Cache CORS por 24h

        if (req.method === 'OPTIONS') {
            return res.status(200).end();
        }

        if (req.method !== 'POST') {
            return res.status(405).json({ error: 'M√©todo n√£o permitido' });
        }

        // ‚úÖ VERIFICA√á√ÉO DE AUTENTICA√á√ÉO (CORRIGIDO: obrigat√≥ria)
        let decodedToken;
        try {
            decodedToken = await verifyAuthToken(req.headers.authorization);
        } catch (authError) {
            console.warn(`üö´ Tentativa de acesso n√£o autenticada: ${authError.message}`);
            return res.status(401).json({
                success: false,
                error: 'Autentica√ß√£o necess√°ria para criar pagamento'
            });
        }

        // ‚úÖ RATE LIMITING
        const clientIP = req.headers['x-forwarded-for'] || req.connection.remoteAddress || 'unknown';
        if (!checkRateLimit(clientIP)) {
            console.warn(`üö´ Rate limit excedido para IP: ${clientIP}`);
            return res.status(429).json({
                success: false,
                error: 'Muitas tentativas. Aguarde 15 minutos.'
            });
        }

        // ‚úÖ DADOS DO USU√ÅRIO AUTENTICADO (n√£o mais do body da requisi√ß√£o)
        const userEmail = decodedToken.email;
        const userName = decodedToken.name || 'Cliente';
        const userId = decodedToken.uid;
        
        console.log(`üîí VERCEL SEGURO: Criando pagamento PIX para usu√°rio: ${userId} (${userEmail})`);

        // ‚úÖ CONFIGURAR EXPIRA√á√ÉO (20 MINUTOS)
        const expirationDate = new Date();
        expirationDate.setMinutes(expirationDate.getMinutes() + 20);

        // ‚úÖ DADOS DO PAGAMENTO (USANDO DADOS DO USU√ÅRIO AUTENTICADO)
        const paymentBody = {
            transaction_amount: 49.90, // Valor fixo (n√£o vem do cliente)
            description: 'Licen√ßa Anual do Atalho - Software de Expans√£o de Texto',
            payment_method_id: 'pix',
            date_of_expiration: expirationDate.toISOString(),
            payer: {
                email: userEmail,
                first_name: userName.split(' ')[0] || 'Cliente',
                last_name: userName.split(' ').slice(1).join(' ') || 'Atalho',
                identification: {
                    type: 'CPF',
                    number: generateValidCPF()
                }
            },
            notification_url: `${origin || 'https://atalho.me'}/api/webhook`,
            metadata: {
                user_id: userId // Associar pagamento ao usu√°rio
            }
        };

        // ‚úÖ CRIAR PAGAMENTO COM IDEMPOT√äNCIA
        const result = await payment.create({ 
            body: paymentBody,
            requestOptions: {
                idempotencyKey: generateSecureIdempotencyKey()
            }
        });
        
        console.log(`‚úÖ VERCEL SEGURO: Pagamento PIX criado: ${result.id}`);

        // ‚úÖ RESPOSTA SEGURA (APENAS DADOS NECESS√ÅRIOS)
        if (result.point_of_interaction?.transaction_data) {
            const qrData = result.point_of_interaction.transaction_data;
            
            return res.status(200).json({
                success: true,
                paymentId: result.id,
                qrCodeBase64: qrData.qr_code_base64,
                qrCodeText: qrData.qr_code,
                expirationDate: result.date_of_expiration,
                status: result.status
            });
        } else {
            console.error('‚ùå VERCEL SEGURO: QR Code n√£o gerado');
            return res.status(400).json({
                success: false,
                error: 'Erro na gera√ß√£o do QR Code'
            });
        }

    } catch (error) {
        console.error('‚ùå VERCEL SEGURO: Erro ao criar pagamento:', error.message);
        
        // ‚úÖ N√ÉO VAZAR DETALHES DO ERRO
        return res.status(500).json({
            success: false,
            error: 'Erro interno do servidor'
        });
    }
}; 