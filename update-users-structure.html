<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atualizar Estrutura de Usu√°rios - Atalho</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .button {
            background: #4CAF50;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .button:hover {
            background: #45a049;
        }
        .danger {
            background: #f44336;
        }
        .danger:hover {
            background: #da190b;
        }
        .info {
            background: #2196F3;
        }
        .info:hover {
            background: #0b7dda;
        }
        .log {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Atualizar Estrutura de Usu√°rios</h1>
        
        <div class="warning">
            <strong>‚ö†Ô∏è ATEN√á√ÉO:</strong> Este script ir√° atualizar TODOS os usu√°rios existentes na cole√ß√£o 'users' 
            adicionando os novos campos necess√°rios. Execute apenas uma vez!
        </div>

        <h3>üìã Campos que ser√£o adicionados/atualizados:</h3>
        <ul>
            <li><strong>company:</strong> null (se n√£o existir)</li>
            <li><strong>license_active:</strong> false</li>
            <li><strong>sub_start:</strong> null</li>
            <li><strong>sub_end:</strong> null</li>
            <li><strong>payment_status:</strong> 'pending'</li>
            <li><strong>license_type:</strong> null</li>
            <li><strong>last_payment_date:</strong> null</li>
        </ul>

        <div>
            <button class="button info" onclick="previewChanges()">üëÅÔ∏è Visualizar Usu√°rios</button>
            <button class="button" onclick="updateUsersStructure()">üöÄ Atualizar Estrutura</button>
            <button class="button danger" onclick="clearLog()">üóëÔ∏è Limpar Log</button>
        </div>

        <div id="log" class="log"></div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="assets/js/firebase.js"></script>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        async function previewChanges() {
            log('üîç Visualizando usu√°rios existentes...');
            
            try {
                const usersSnapshot = await db.collection('users').get();
                
                if (usersSnapshot.empty) {
                    log('‚ùå Nenhum usu√°rio encontrado na cole√ß√£o.');
                    return;
                }

                log(`üìä Encontrados ${usersSnapshot.size} usu√°rios:`);
                log('');

                usersSnapshot.forEach((doc) => {
                    const userData = doc.data();
                    log(`üë§ ID: ${doc.id}`);
                    log(`   Nome: ${userData.name || 'N/A'}`);
                    log(`   Email: ${userData.email || 'N/A'}`);
                    log(`   Company: ${userData.company || 'N√ÉO EXISTE'}`);
                    log(`   License Active: ${userData.license_active || 'N√ÉO EXISTE'}`);
                    log(`   Sub Start: ${userData.sub_start || 'N√ÉO EXISTE'}`);
                    log(`   Sub End: ${userData.sub_end || 'N√ÉO EXISTE'}`);
                    log('   ---');
                });

            } catch (error) {
                log(`‚ùå Erro ao buscar usu√°rios: ${error.message}`);
            }
        }

        async function updateUsersStructure() {
            log('üöÄ Iniciando atualiza√ß√£o da estrutura de usu√°rios...');
            
            try {
                const usersSnapshot = await db.collection('users').get();
                
                if (usersSnapshot.empty) {
                    log('‚ùå Nenhum usu√°rio encontrado na cole√ß√£o.');
                    return;
                }

                log(`üìä Processando ${usersSnapshot.size} usu√°rios...`);
                log('');

                let updatedCount = 0;
                let skippedCount = 0;

                for (const doc of usersSnapshot.docs) {
                    const userData = doc.data();
                    const userId = doc.id;
                    
                    // Preparar dados de atualiza√ß√£o
                    const updateData = {};
                    let needsUpdate = false;

                    // Verificar e adicionar campos faltantes
                    if (!userData.hasOwnProperty('company')) {
                        updateData.company = null;
                        needsUpdate = true;
                    }

                    if (!userData.hasOwnProperty('license_active')) {
                        updateData.license_active = false;
                        needsUpdate = true;
                    }

                    if (!userData.hasOwnProperty('sub_start')) {
                        updateData.sub_start = null;
                        needsUpdate = true;
                    }

                    if (!userData.hasOwnProperty('sub_end')) {
                        updateData.sub_end = null;
                        needsUpdate = true;
                    }

                    if (!userData.hasOwnProperty('payment_status')) {
                        updateData.payment_status = 'pending';
                        needsUpdate = true;
                    }

                    if (!userData.hasOwnProperty('license_type')) {
                        updateData.license_type = null;
                        needsUpdate = true;
                    }

                    if (!userData.hasOwnProperty('last_payment_date')) {
                        updateData.last_payment_date = null;
                        needsUpdate = true;
                    }

                    if (needsUpdate) {
                        try {
                            await db.collection('users').doc(userId).update(updateData);
                            log(`‚úÖ Usu√°rio ${userData.name || userData.email} atualizado`);
                            updatedCount++;
                        } catch (error) {
                            log(`‚ùå Erro ao atualizar usu√°rio ${userId}: ${error.message}`);
                        }
                    } else {
                        log(`‚è≠Ô∏è Usu√°rio ${userData.name || userData.email} j√° possui todos os campos`);
                        skippedCount++;
                    }
                }

                log('');
                log('üéâ ATUALIZA√á√ÉO CONCLU√çDA!');
                log(`‚úÖ Usu√°rios atualizados: ${updatedCount}`);
                log(`‚è≠Ô∏è Usu√°rios j√° atualizados: ${skippedCount}`);
                log(`üìä Total processado: ${updatedCount + skippedCount}`);

            } catch (error) {
                log(`‚ùå Erro geral na atualiza√ß√£o: ${error.message}`);
            }
        }

        // Inicializa√ß√£o
        window.addEventListener('load', function() {
            log('üîß Script de atualiza√ß√£o carregado');
            log('üëÜ Clique em "Visualizar Usu√°rios" para ver a estrutura atual');
            log('');
        });
    </script>
</body>
</html> 