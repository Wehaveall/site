<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete seu Cadastro - Atalho</title>
    <link rel="stylesheet" href="assets/css/style.css">
    
    <style>
        /* Estilos espec√≠ficos para a p√°gina de registro */
        #login-email:focus, #login-password:focus, #confirm-password:focus,
        #customer-name:focus, #customer-phone:focus, #customer-company:focus {
            border-color: var(--primary) !important;
            outline: none;
            box-shadow: 0 0 0 3px rgba(219, 201, 173, 0.2);
        }
        
        #complete-registration-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        a[href="#"]:hover {
            color: var(--primary) !important;
        }
    </style>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="navbar">
            <div class="logo">
                <a href="index.html" class="logo-link">
                    <img src="assets/img/Atalho.png" alt="Logo Atalho" class="logo-img" />
                    <span class="logo-text">Atalho</span>
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main style="padding-top: 100px; min-height: 100vh; background: linear-gradient(120deg, #f0e9df 0%, #f7f3ed 20%, white 50%);">
        <div class="container" style="max-width: 600px; margin: 0 auto; padding: 2rem;">

            <!-- Formul√°rio de Cadastro -->
            <div id="registration-form" style="background: white; border-radius: 12px; padding: 2rem; margin-bottom: 2rem; box-shadow: var(--shadow-lg);">
                <h2 style="color: var(--text-dark); margin-bottom: 1rem; text-align: center;">
                    Crie sua Conta do Atalho
                </h2>
                <p style="color: var(--text-light); text-align: center; margin-bottom: 2rem;">
                    Complete seu cadastro para come√ßar a usar o Atalho
                </p>

                <form id="customer-registration-form">
                    <!-- Se√ß√£o de Login -->
                    <div style="background: #faf8f5; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; border-left: 4px solid var(--primary-dark);">
                        <h3 style="color: var(--text-dark); margin-bottom: 1rem; font-size: 1.1rem;">üîê Dados de Acesso</h3>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-dark); font-weight: 500;">
                                Email de Login *
                            </label>
                            <input type="email" id="login-email" required
                                   style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 6px; font-size: 1rem; transition: border-color 0.2s ease;"
                                   placeholder="seu@email.com">
                            <small style="color: var(--text-light);">Este ser√° seu email de login no sistema</small>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-dark); font-weight: 500;">
                                Senha *
                            </label>
                            <input type="password" id="login-password" required minlength="8"
                                   style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 6px; font-size: 1rem; transition: border-color 0.2s ease;"
                                   placeholder="M√≠nimo 8 caracteres">
                            <div id="password-requirements" style="margin-top: 0.5rem; font-size: 0.85rem;">
                                <div id="req-length" style="color: #dc3545;">‚úó M√≠nimo 8 caracteres</div>
                                <div id="req-uppercase" style="color: #dc3545;">‚úó Uma letra mai√∫scula</div>
                                <div id="req-number" style="color: #dc3545;">‚úó Um n√∫mero</div>
                                <div id="req-symbol" style="color: #dc3545;">‚úó Um caractere especial</div>
                            </div>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-dark); font-weight: 500;">
                                Confirmar Senha *
                            </label>
                            <input type="password" id="confirm-password" required minlength="8"
                                   style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 6px; font-size: 1rem; transition: border-color 0.2s ease;"
                                   placeholder="Digite a senha novamente">
                        </div>
                    </div>

                    <!-- Se√ß√£o de Dados Pessoais -->
                    <div style="background: #faf8f5; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; border-left: 4px solid var(--primary-dark);">
                        <h3 style="color: var(--text-dark); margin-bottom: 1rem; font-size: 1.1rem;">üë§ Dados Pessoais</h3>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-dark); font-weight: 500;">
                                Nome Completo *
                            </label>
                            <input type="text" id="customer-name" required
                                   style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 6px; font-size: 1rem; transition: border-color 0.2s ease;"
                                   placeholder="Seu nome completo">
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-dark); font-weight: 500;">
                                Telefone (opcional)
                            </label>
                            <input type="tel" id="customer-phone"
                                   style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 6px; font-size: 1rem; transition: border-color 0.2s ease;"
                                   placeholder="(11) 99999-9999">
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-dark); font-weight: 500;">
                                Empresa (opcional)
                            </label>
                            <input type="text" id="customer-company"
                                   style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 6px; font-size: 1rem; transition: border-color 0.2s ease;"
                                   placeholder="Nome da sua empresa">
                        </div>
                    </div>

                    <div style="margin-bottom: 2rem;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="terms-accept" required style="margin-right: 0.5rem;">
                            <span style="color: var(--text-dark);">
                                Aceito os <a href="termos-de-uso.html" style="color: var(--primary-dark); transition: color 0.2s ease;">termos de uso</a> e 
                                <a href="politica-de-privacidade.html" style="color: var(--primary-dark); transition: color 0.2s ease;">pol√≠tica de privacidade</a>
                            </span>
                        </label>
                    </div>

                    <button type="submit" id="complete-registration-btn"
                            style="width: 100%; padding: 1rem; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: var(--text-dark); border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
                        Criar Conta
                    </button>
                </form>
            </div>


        </div>
    </main>

    <!-- Scripts -->
    <script src="assets/js/security-validator.js"></script>
    <script src="assets/js/firebase.js"></script>

    <script>
        // Fun√ß√£o para mostrar mensagens
        function showSuccess(message) {
            alert('‚úÖ ' + message);
        }

        function showError(message) {
            alert('‚ùå ' + message);
        }

        // Fun√ß√£o para validar senhas com novos requisitos
        function validatePasswords() {
            const password = document.getElementById('login-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            if (password !== confirmPassword) {
                showError('As senhas n√£o coincidem.');
                return false;
            }
            
            // Valida√ß√£o rigorosa da senha
            if (password.length < 8) {
                showError('A senha deve ter pelo menos 8 caracteres.');
                return false;
            }
            
            if (!/[A-Z]/.test(password)) {
                showError('A senha deve conter pelo menos uma letra mai√∫scula.');
                return false;
            }
            
            if (!/[0-9]/.test(password)) {
                showError('A senha deve conter pelo menos um n√∫mero.');
                return false;
            }
            
            if (!/[:$%#@!*&^()_+\-=\[\]{};':"\\|,.<>\/?~`]/.test(password)) {
                showError('A senha deve conter pelo menos um caractere especial.');
                return false;
            }
            
            return true;
        }



        // Fun√ß√£o para criar conta Firebase Auth
        async function createFirebaseAccount(email, password) {
            try {
                console.log('üîê Criando conta Firebase Auth...');
                
                const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                console.log('‚úÖ Conta Firebase criada:', user.uid);
                return user;
            } catch (error) {
                console.error('‚ùå Erro ao criar conta Firebase:', error);
                
                // Traduz erros comuns do Firebase
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        throw new Error('Este email j√° est√° em uso. Tente fazer login ou use outro email.');
                    case 'auth/invalid-email':
                        throw new Error('Email inv√°lido.');
                    case 'auth/weak-password':
                        throw new Error('Senha muito fraca. Use pelo menos 8 caracteres, 1 mai√∫scula, 1 n√∫mero e 1 caractere especial.');
                    default:
                        throw new Error('Erro ao criar conta: ' + error.message);
                }
            }
        }

        // Inicializa√ß√£o da p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìù P√°gina de registro carregada');
        });

        // Manipulador do formul√°rio de registro
        document.getElementById('customer-registration-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const loginEmail = document.getElementById('login-email').value.trim();
            const loginPassword = document.getElementById('login-password').value;
            const name = document.getElementById('customer-name').value.trim();
            const phone = document.getElementById('customer-phone').value.trim();
            const company = document.getElementById('customer-company').value.trim();
            const termsAccepted = document.getElementById('terms-accept').checked;

            // ‚úÖ VALIDA√á√ÉO DE SEGURAN√áA RIGOROSA
            const formData = { name, email: loginEmail, password: loginPassword, phone, company };
            
            // Verificar se h√° tentativas de inje√ß√£o ou manipula√ß√£o
            if (window.securityValidator && !window.securityValidator.validateRegistrationAttempt(formData)) {
                showError('Dados inv√°lidos detectados. Por favor, verifique as informa√ß√µes.');
                return;
            }

            // Valida√ß√µes b√°sicas
            if (!name || !loginEmail || !loginPassword) {
                showError('Por favor, preencha todos os campos obrigat√≥rios.');
                return;
            }

            if (!validatePasswords()) {
                return;
            }

            if (!termsAccepted) {
                showError('Por favor, aceite os termos de uso.');
                return;
            }

            // Valida√ß√£o rigorosa de email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(loginEmail) || loginEmail.length > 254) {
                showError('Por favor, insira um email v√°lido.');
                return;
            }

            // Desabilita o bot√£o durante o processamento
            const btn = document.getElementById('complete-registration-btn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '‚è≥ Criando conta...';

            try {
                // 1. Cria conta no Firebase Auth
                const firebaseUser = await createFirebaseAccount(loginEmail, loginPassword);
                
                // 2. Prepara dados do cliente
                const customerData = {
                    name,
                    email: loginEmail,
                    phone: phone || null,
                    company: company || null,
                    terms_accepted: true,
                    terms_accepted_at: new Date().toISOString(),
                    created_at: firebase.firestore.FieldValue.serverTimestamp()
                };

                // 3. Salva dados do usu√°rio no Firestore
                const userRef = db.collection('users').doc(firebaseUser.uid);
                await userRef.set(customerData);
                
                // 4. Sucesso!
                showSuccess('üéâ Conta criada com sucesso!');
                
                // 5. Redireciona para p√°gina de dashboard
                setTimeout(() => {
                    window.location.href = `dashboard.html`;
                }, 2000);

            } catch (error) {
                console.error("Erro ao completar registro:", error);
                showError('Erro: ' + error.message);
            } finally {
                // Reabilita o bot√£o
                btn.disabled = false;
                btn.textContent = originalText;
            }
        });

        // Fun√ß√£o para atualizar indicadores de requisitos da senha
        function updatePasswordRequirements(password) {
            const requirements = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                number: /[0-9]/.test(password),
                symbol: /[:$%#@!*&^()_+\-=\[\]{};':"\\|,.<>\/?~`]/.test(password)
            };

            // Atualizar indicadores visuais
            document.getElementById('req-length').innerHTML = requirements.length ? 
                '<span style="color: #28a745;">‚úì M√≠nimo 8 caracteres</span>' : 
                '<span style="color: #dc3545;">‚úó M√≠nimo 8 caracteres</span>';
                
            document.getElementById('req-uppercase').innerHTML = requirements.uppercase ? 
                '<span style="color: #28a745;">‚úì Uma letra mai√∫scula</span>' : 
                '<span style="color: #dc3545;">‚úó Uma letra mai√∫scula</span>';
                
            document.getElementById('req-number').innerHTML = requirements.number ? 
                '<span style="color: #28a745;">‚úì Um n√∫mero</span>' : 
                '<span style="color: #dc3545;">‚úó Um n√∫mero</span>';
                
            document.getElementById('req-symbol').innerHTML = requirements.symbol ? 
                '<span style="color: #28a745;">‚úì Um caractere especial</span>' : 
                '<span style="color: #dc3545;">‚úó Um caractere especial</span>';

            // Alterar cor da borda do campo
            const passwordField = document.getElementById('login-password');
            if (password.length > 0) {
                const allValid = Object.values(requirements).every(req => req);
                passwordField.style.borderColor = allValid ? '#28a745' : '#dc3545';
            } else {
                passwordField.style.borderColor = '#e9ecef';
            }
        }

        // Valida√ß√£o em tempo real da senha
        document.getElementById('login-password').addEventListener('input', function() {
            updatePasswordRequirements(this.value);
        });

        // Valida√ß√£o em tempo real das senhas
        document.getElementById('confirm-password').addEventListener('input', function() {
            const password = document.getElementById('login-password').value;
            const confirmPassword = this.value;
            
            if (confirmPassword && password !== confirmPassword) {
                this.style.borderColor = '#dc3545';
            } else if (confirmPassword && password === confirmPassword) {
                this.style.borderColor = '#28a745';
            } else {
                this.style.borderColor = '#e9ecef';
            }
        });

        // Efeito hover no bot√£o
        document.getElementById('complete-registration-btn').addEventListener('mouseenter', function() {
            if (!this.disabled) {
                this.style.transform = 'translateY(-2px)';
            }
        });

        document.getElementById('complete-registration-btn').addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });

        console.log("üöÄ P√°gina de registro simplificada carregada");
    </script>
</body>

</html> 