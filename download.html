<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="download.title">Download Atalho</title>
    <link rel="stylesheet" href="assets/css/style.css">
    
    <style>
        /* Estilos espec√≠ficos para a p√°gina de download */
        .download-container {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            margin-top: 100px; /* Espa√ßo para o header */
        }

        .container {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 40px;
        }

        h1 {
            color: #2b2a2a;
            text-align: center;
        }

        .subtitle {
            color: #dbc9ad;
            font-size: 1.2rem;
            text-align: center;
            margin-bottom: 40px;
        }

        .download-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 40px;
        }

        .download-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .download-button {
            display: inline-block;
            background-color: #2b2a2a;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            text-decoration: none;
            margin-top: 15px;
            font-weight: bold;
        }

        .download-button:hover {
            background-color: #dbc9ad;
        }

        .error-container {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 30px;
            margin-top: 40px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .error-icon {
            font-size: 48px;
            color: #f44336;
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 600px) {
            .download-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <!-- Firebase SDKs - Vers√£o atualizada -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>
</head>

<body>
    <!-- Header Completo (igual √†s outras p√°ginas) -->
    <header class="header">
        <div class="navbar">
            <div class="logo">
                <a href="index.html" class="logo-link">
                    <img src="assets/img/Atalho.png" alt="Logo Atalho" class="logo-img" />
                    <span class="logo-text">Atalho</span>
                </a>
            </div>
            <nav class="nav-menu">
                <ul class="nav-links" id="nav-links">
                    <!-- O dropdown de idiomas ser√° inserido aqui automaticamente -->
                    <li><a href="index.html#features" class="nav-link" data-i18n="header.features">Recursos</a></li>
                    <li><a href="tutoriais.html" class="nav-link" data-i18n="header.tutorials">Tutoriais</a></li>
                    <li><a href="index.html#downloads" class="nav-link nav-link-multiline" data-i18n="header.downloads">Downloads de Bibliotecas</a></li>
                    <!-- Links din√¢micos baseados na autentica√ß√£o -->
                    <li id="nav-register" style="display: none;"><a href="register.html" class="nav-link" data-i18n="header.register">Cadastro</a></li>
                    <li id="nav-login" style="display: none;"><a href="login.html" class="nav-link" data-i18n="header.login">Entrar</a></li>
                    <li id="nav-user-info" style="display: none;">
                        <a href="dashboard.html" class="nav-link" style="color: #28a745; font-weight: 600;" id="nav-user-name" data-i18n="dashboard.loading">Carregando...</a>
                    </li>
                    <li id="nav-logout" style="display: none;"><a href="#" class="nav-link" onclick="logout()" data-i18n="dashboard.logout">Sair</a></li>
                    <li><a href="comprar.html" class="nav-link btn-primary" data-i18n="header.buy">Comprar</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="download-container">
        <div id="app-container">
            <!-- O conte√∫do ser√° inserido dinamicamente ap√≥s verifica√ß√£o -->
            <div class="loading">
                <div class="loading-spinner"></div>
                <p data-i18n="download.loading">Verificando sua conta...</p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="assets/js/firebase.js"></script>
    <script src="assets/js/i18n.js"></script>

    <script>
        // Vari√°veis globais
        let currentUser = null;
        let currentUserData = null;
        let i18nSystem = null;

        // Fun√ß√£o para logout
        async function logout() {
            try {
                // Usar a inst√¢ncia global do auth se dispon√≠vel
                if (window.auth) {
                    await window.auth.signOut();
                } else {
                    await firebase.auth().signOut();
                }
                console.log('‚úÖ Logout realizado com sucesso');
                updateNavMenu(null); // Atualiza menu para usu√°rio deslogado
                currentUserData = null;
                currentUser = null;
                // Recarregar p√°gina para mostrar erro de acesso
                window.location.reload();
            } catch (error) {
                console.error('‚ùå Erro no logout:', error);
                alert((window.i18nSystem?.t('common.error') || 'Erro') + ': ' + error.message);
            }
        }

        // Fun√ß√£o para buscar dados do usu√°rio no Firestore
        async function loadUserData(uid) {
            try {
                console.log('üìä Buscando dados do usu√°rio:', uid);
                
                // Usar a inst√¢ncia global do db se dispon√≠vel
                const firestore = window.db || firebase.firestore();
                
                // Buscar dados do usu√°rio
                const userDoc = await firestore.collection('users').doc(uid).get();
                
                if (userDoc.exists) {
                    currentUserData = userDoc.data();
                    console.log('‚úÖ Dados do usu√°rio carregados:', currentUserData);
                    return currentUserData;
                } else {
                    console.log('‚ö†Ô∏è Documento do usu√°rio n√£o encontrado');
                    // Tentar buscar por email
                    const emailQuery = await firestore.collection('users')
                        .where('email', '==', currentUser.email)
                        .limit(1)
                        .get();
                    
                    if (!emailQuery.empty) {
                        currentUserData = emailQuery.docs[0].data();
                        console.log('‚úÖ Dados encontrados por email:', currentUserData);
                        return currentUserData;
                    }
                }
                
                return null;
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados do usu√°rio:', error);
                return null;
            }
        }

        // Fun√ß√£o para atualizar o menu baseado no status de autentica√ß√£o
        async function updateNavMenu(user) {
            console.log('üîß === IN√çCIO DA ATUALIZA√á√ÉO DO MENU (DOWNLOAD) ===');
            console.log('üë§ Usu√°rio recebido:', user ? user.email : 'null/undefined');
            
            const navRegister = document.getElementById('nav-register');
            const navLogin = document.getElementById('nav-login');
            const navUserInfo = document.getElementById('nav-user-info');
            const navUserName = document.getElementById('nav-user-name');
            const navLogout = document.getElementById('nav-logout');

            if (user) {
                console.log('‚úÖ USU√ÅRIO LOGADO - Configurando menu para usu√°rio autenticado');
                
                // Usu√°rio logado: esconder Cadastro/Entrar, mostrar Nome/Sair
                if (navRegister) {
                    navRegister.style.display = 'none';
                }
                if (navLogin) {
                    navLogin.style.display = 'none';
                }
                if (navUserInfo) {
                    navUserInfo.style.display = 'block';
                }
                if (navLogout) {
                    navLogout.style.display = 'block';
                }
                
                // Carregar dados do usu√°rio (COM CACHE)
                let userData = currentUserData;
                if (!userData || currentUserData?.uid !== user.uid) {
                    console.log('üìä Carregando dados do usu√°rio do Firestore...');
                    userData = await loadUserData(user.uid);
                    currentUserData = userData; // Cache dos dados
                } else {
                    console.log('‚ö° Usando dados em cache do usu√°rio');
                }
                
                // Definir nome a ser exibido
                let firstName = '';
                let lastName = '';
                
                if (userData && userData.Nome) {
                    // Pegar o nome completo
                    const fullName = userData.Nome.trim();
                    
                    // Dividir o nome em partes
                    const nameParts = fullName.split(' ').filter(part => part.length > 0);
                    
                    if (nameParts.length === 1) {
                        // Se s√≥ tem uma palavra, usa ela na primeira linha
                        firstName = nameParts[0];
                    } else if (nameParts.length > 1) {
                        // Pegar primeiro e √∫ltimo nome
                        firstName = nameParts[0];
                        lastName = nameParts[nameParts.length - 1];
                        
                        // Se algum dos nomes for muito grande (mais que 12 caracteres), trunca
                        if (firstName.length > 12) {
                            firstName = firstName.substring(0, 9) + '...';
                        }
                        if (lastName.length > 12) {
                            lastName = lastName.substring(0, 9) + '...';
                        }
                    }
                    
                    console.log('  üìõ Nome obtido do Firestore:', firstName, lastName);
                } else if (user.displayName) {
                    // Mesmo processo para displayName do Firebase Auth
                    const fullName = user.displayName.trim();
                    const nameParts = fullName.split(' ').filter(part => part.length > 0);
                    
                    if (nameParts.length === 1) {
                        firstName = nameParts[0];
                    } else if (nameParts.length > 1) {
                        firstName = nameParts[0];
                        lastName = nameParts[nameParts.length - 1];
                        
                        if (firstName.length > 12) {
                            firstName = firstName.substring(0, 9) + '...';
                        }
                        if (lastName.length > 12) {
                            lastName = lastName.substring(0, 9) + '...';
                        }
                    }
                    
                    console.log('  üìõ Nome obtido do Firebase Auth:', firstName, lastName);
                } else {
                    // Usar primeira parte do email como fallback
                    firstName = user.email.split('@')[0];
                    console.log('  üìõ Nome obtido do email:', firstName);
                }
                
                if (navUserName) {
                    // Criar estrutura HTML para exibir o nome em duas linhas
                    navUserName.innerHTML = `
                        <div style="line-height: 1.2; text-align: center;">
                            <div style="font-weight: 600;">${firstName}</div>
                            ${lastName ? `<div style="font-size: 0.9em; opacity: 0.9;">${lastName}</div>` : ''}
                        </div>
                    `;
                    navUserName.title = userData?.Nome || user.email || 'Usu√°rio'; // Tooltip com nome completo
                    console.log('  ‚úÖ Nome definido no elemento:', firstName, lastName);
                }
                
                console.log('‚úÖ Menu atualizado para usu√°rio logado:', user.email, '| Nome:', firstName, lastName);
            } else {
                console.log('‚ùå USU√ÅRIO DESLOGADO - Configurando menu para usu√°rio n√£o autenticado');
                
                // Usu√°rio deslogado: mostrar Cadastro/Entrar, esconder Nome/Sair
                if (navRegister) {
                    navRegister.style.display = 'block';
                }
                if (navLogin) {
                    navLogin.style.display = 'block';
                }
                if (navUserInfo) {
                    navUserInfo.style.display = 'none';
                }
                if (navLogout) {
                    navLogout.style.display = 'none';
                }
                currentUserData = null;
            }
        }

        // Principais elementos da p√°gina
        const appContainer = document.getElementById('app-container');

        // Fun√ß√£o para mostrar erro de acesso n√£o autorizado
        function showUnauthorizedError() {
            const errorTitle = i18nSystem?.t('download.unauthorized.title') || 'Acesso Restrito';
            const errorMessage1 = i18nSystem?.t('download.unauthorized.message1') || 'Esta p√°gina √© exclusiva para usu√°rios cadastrados que realizaram o pagamento.';
            const errorMessage2 = i18nSystem?.t('download.unauthorized.message2') || 'Se voc√™ j√° realizou o pagamento, fa√ßa login para continuar.';
            const buyButton = i18nSystem?.t('download.unauthorized.buyButton') || 'Adquirir Licen√ßa';
            const backButton = i18nSystem?.t('download.unauthorized.backButton') || 'Voltar √† p√°gina inicial';

            appContainer.innerHTML = `
                <div class="error-container">
                    <div class="error-icon">‚ö†Ô∏è</div>
                    <h1>${errorTitle}</h1>
                    <p>${errorMessage1}</p>
                    <p>${errorMessage2}</p>
                    <div style="margin-top: 30px;">
                        <a href="comprar.html" class="download-button">${buyButton}</a>
                        <a href="index.html" style="display: block; margin-top: 20px; color: #666; text-decoration: none;">${backButton}</a>
                    </div>
                </div>
            `;
        }

        // Fun√ß√£o para mostrar a p√°gina de downloads para usu√°rios autorizados
        function showDownloadPage(userData) {
            const pageTitle = i18nSystem?.t('download.title') || 'Download do Atalho';
            const pageSubtitle = i18nSystem?.t('download.subtitle') || 'Escolha sua plataforma para come√ßar';
            const welcomeText = i18nSystem?.t('download.welcome') || 'Bem-vindo(a)';
            const licenseText = i18nSystem?.t('download.licenseValid') || 'Sua licen√ßa √© v√°lida at√©';
            const windowsText = i18nSystem?.t('download.windows') || 'Windows';
            const macosText = i18nSystem?.t('download.macos') || 'macOS';
            const windowsDesc = i18nSystem?.t('download.windowsDesc') || 'Compat√≠vel com Windows 10 e 11';
            const macosDesc = i18nSystem?.t('download.macosDesc') || 'Compat√≠vel com macOS 11 ou superior';
            const downloadWindows = i18nSystem?.t('download.downloadWindows') || 'Baixar para Windows';
            const downloadMacos = i18nSystem?.t('download.downloadMacos') || 'Baixar para macOS';
            const backHome = i18nSystem?.t('download.backHome') || 'Voltar √† p√°gina inicial';

            appContainer.innerHTML = `
                <div class="container">
                    <h1>${pageTitle}</h1>
                    <div class="subtitle">${pageSubtitle}</div>
                    
                    <div style="background-color: #e8f5e9; padding: 15px; border-radius: 4px; margin-bottom: 20px; text-align: left;">
                        <p>${welcomeText}, <strong>${userData.email || 'Usu√°rio'}</strong></p>
                        <p>${licenseText} ${new Date(userData.sub_end).toLocaleDateString()}</p>
                    </div>
                    
                    <div class="download-grid">
                        <div class="download-card">
                            <h3>${windowsText}</h3>
                            <p>${windowsDesc}</p>
                            <a href="#" class="download-button">${downloadWindows}</a>
                        </div>
                        
                        <div class="download-card">
                            <h3>${macosText}</h3>
                            <p>${macosDesc}</p>
                            <a href="#" class="download-button">${downloadMacos}</a>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 40px;">
                        <a href="index.html" style="color: #666; text-decoration: none;">${backHome}</a>
                    </div>
                </div>
            `;
        }

        // Inicializa√ß√£o da p√°gina
        document.addEventListener('DOMContentLoaded', async function () {
            console.log('üöÄ P√°gina de download inicializada');

            // ‚úÖ PRIMEIRO: Aguardar sistema i18n estar pronto
            try {
                let attempts = 0;
                while (!window.i18nSystem && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (window.i18nSystem) {
                    i18nSystem = window.i18nSystem;
                    console.log('üåç Sistema de tradu√ß√£o carregado no download');
                    
                    // Aplicar tradu√ß√µes iniciais
                    i18nSystem.applyTranslations();
                    
                    // Configurar event listener para mudan√ßas de idioma
                    window.addEventListener('languageChanged', function(event) {
                        console.log('üåç Idioma alterado para:', event.detail.language);
                        i18nSystem.applyTranslations();
                    });
                } else {
                    console.warn('‚ö†Ô∏è Sistema de tradu√ß√£o n√£o encontrado no download');
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar sistema de tradu√ß√£o no download:', error);
            }

            // ‚úÖ SEGUNDO: Inicializar Firebase e verificar autentica√ß√£o
            try {
                console.log('üî• Inicializando Firebase na p√°gina de download...');
                
                // Aguardar inicializa√ß√£o do Firebase usando a fun√ß√£o getFirebaseServices
                const { auth, db, functions } = await getFirebaseServices();
                console.log("‚úÖ Servi√ßos do Firebase prontos para a p√°gina de download");
                
                // Configurar verifica√ß√£o de autentica√ß√£o
                auth.onAuthStateChanged(async function (user) {
                    console.log('üîÑ onAuthStateChanged disparado na p√°gina de download:', user ? user.email : 'Usu√°rio deslogado');
                    
                    currentUser = user;
                    
                    // Atualizar menu din√¢mico
                    await updateNavMenu(user);
                    
                    if (user) {
                        console.log('Usu√°rio autenticado:', user.uid);

                        try {
                            // Verificar no Firestore se o usu√°rio tem acesso
                            const userData = await loadUserData(user.uid);

                            if (userData) {
                                console.log('Dados do usu√°rio:', userData);

                                // Verificar se o usu√°rio tem status ativo
                                if (userData.status === 'active') {
                                    // Verificar se a assinatura est√° v√°lida
                                    const subEnd = new Date(userData.sub_end);
                                    const now = new Date();

                                    if (subEnd > now) {
                                        console.log('Usu√°rio autorizado. Exibindo p√°gina de downloads.');
                                        showDownloadPage(userData);
                                    } else {
                                        console.log('Assinatura expirada.');
                                        showUnauthorizedError();
                                    }
                                } else {
                                    console.log('Status do usu√°rio n√£o √© ativo.');
                                    showUnauthorizedError();
                                }
                            } else {
                                console.log('Documento do usu√°rio n√£o existe.');
                                showUnauthorizedError();
                            }
                        } catch (error) {
                            console.error('Erro ao verificar dados do usu√°rio:', error);
                            showUnauthorizedError();
                        }
                    } else {
                        console.log('Usu√°rio n√£o autenticado.');

                        // Verificar token de sucesso (fallback tempor√°rio)
                        const hasValidCheckout = localStorage.getItem('successfulCheckout');
                        const userEmail = localStorage.getItem('userEmail');
                        const userId = localStorage.getItem('userId');
                        const checkoutExpiry = localStorage.getItem('checkoutExpiry');

                        // Verificar se o token n√£o expirou
                        let tokenValid = false;
                        if (checkoutExpiry) {
                            const expiryDate = new Date(checkoutExpiry);
                            tokenValid = expiryDate > new Date();
                        }

                        if (hasValidCheckout === 'true' && userEmail && userId && tokenValid) {
                            console.log('Token de compra recente encontrado e v√°lido.');

                            const sessionExpiredText = i18nSystem?.t('download.sessionExpired.title') || 'Aten√ß√£o: Sua sess√£o expirou, mas detectamos que voc√™ concluiu uma compra recentemente.';
                            const loginAgainText = i18nSystem?.t('download.sessionExpired.message') || 'Para sua seguran√ßa, fa√ßa login novamente para acessar todos os recursos.';
                            const loginButtonText = i18nSystem?.t('download.sessionExpired.loginButton') || 'Fazer Login';

                            // Mostrar p√°gina com alerta
                            appContainer.innerHTML = `
                                <div class="container">
                                    <div style="background-color: #fff3cd; padding: 15px; border-radius: 4px; margin-bottom: 20px; text-align: left;">
                                        <p><strong>${sessionExpiredText}</strong></p>
                                        <p>${loginAgainText}</p>
                                        <a href="login.html" style="display: inline-block; margin-top: 10px; padding: 5px 15px; background: #2b2a2a; color: white; text-decoration: none; border-radius: 4px;">${loginButtonText}</a>
                                    </div>
                                    
                                    <h1>${i18nSystem?.t('download.title') || 'Download do Atalho'}</h1>
                                    <div class="subtitle">${i18nSystem?.t('download.subtitle') || 'Escolha sua plataforma para come√ßar'}</div>
                                    
                                    <div class="download-grid">
                                        <div class="download-card">
                                            <h3>${i18nSystem?.t('download.windows') || 'Windows'}</h3>
                                            <p>${i18nSystem?.t('download.windowsDesc') || 'Compat√≠vel com Windows 10 e 11'}</p>
                                            <a href="#" class="download-button">${i18nSystem?.t('download.downloadWindows') || 'Baixar para Windows'}</a>
                                        </div>
                                        
                                        <div class="download-card">
                                            <h3>${i18nSystem?.t('download.macos') || 'macOS'}</h3>
                                            <p>${i18nSystem?.t('download.macosDesc') || 'Compat√≠vel com macOS 11 ou superior'}</p>
                                            <a href="#" class="download-button">${i18nSystem?.t('download.downloadMacos') || 'Baixar para macOS'}</a>
                                        </div>
                                    </div>
                                    
                                    <div style="text-align: center; margin-top: 40px;">
                                        <a href="index.html" style="color: #666; text-decoration: none;">${i18nSystem?.t('download.backHome') || 'Voltar √† p√°gina inicial'}</a>
                                    </div>
                                </div>
                            `;
                        } else {
                            showUnauthorizedError();
                        }
                    }
                });
                
            } catch (error) {
                console.error("‚ùå Falha na inicializa√ß√£o do Firebase na p√°gina de download:", error);
                showUnauthorizedError();
            }
        });

        console.log("üöÄ P√°gina de download carregada - Sistema de autentica√ß√£o integrado");
    </script>
</body>

</html>