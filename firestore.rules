rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // =====================================
    // 白 COLEﾃﾃ髭S SEGURAS POR PADRﾃグ
    // =====================================
    
    // Bloqueia acesso a coleﾃｧﾃｵes sensﾃｭveis que sﾃｳ devem ser acessadas pelo backend
    match /mail/{docId} {
      allow read, write: if false;
    }
    
    match /approved_payments/{docId} {
        allow read, write: if false;
    }

    match /chargebacks/{docId} {
        allow read, write: if false;
    }

    // =====================================
    // 白 REGRAS PARA A COLEﾃﾃグ DE USUﾃヽIOS
    // =====================================
    
    match /users/{userId} {
    
      // LEITURA: Permitida apenas pelo prﾃｳprio usuﾃ｡rio.
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // LEITURA (para queries): Permitida apenas quando o usuﾃ｡rio estﾃ｡ autenticado
      // e estﾃ｡ buscando seus prﾃｳprios dados
      allow read: if request.auth != null && 
                     (resource.data.user.uid == request.auth.uid || 
                      resource.data.email == request.auth.token.email ||
                      userId == request.auth.uid);
      
      // CRIAﾃﾃグ: Desabilitada para o cliente.
      allow create: if false;
      
      // ATUALIZAﾃﾃグ: Permitida pelo usuﾃ｡rio, mas com regras muito estritas.
      allow update: if request.auth != null 
                     && request.auth.uid == userId
                     // 1. Valida APENAS os campos que o usuﾃ｡rio PODE mudar.
                     && validateProfileUpdate(request.resource.data)
                     // 2. Garante que campos crﾃｭticos Nﾃグ foram alterados.
                     && areImmutableFieldsUnchanged(['email', 'id', 'license_active', 'sub_end', 'created_at', 'payment_status']);
                     
      // EXCLUSﾃグ: Desabilitada para o cliente.
      allow delete: if false;
    }
    
    // Qualquer outra coleﾃｧﾃ｣o nﾃ｣o especificada ﾃｩ bloqueada por padrﾃ｣o
    match /{document=**} {
      allow read, write: if false;
    }
    
    // =====================================
    // 肌 FUNﾃﾃ髭S DE VALIDAﾃﾃグ CORRIGIDAS
    // =====================================
    
    // Funﾃｧﾃ｣o especﾃｭfica e segura para validar a ATUALIZAﾃﾃグ do perfil pelo usuﾃ｡rio.
    function validateProfileUpdate(data) {
      return (data.Nome is string && data.Nome.size() > 0 && data.Nome.size() <= 100)
          && (data.phone == null || (data.phone is string && data.phone.size() <= 20))
          && (data.company == null || (data.company is string && data.company.size() <= 100))
          && (data.country == null || (data.country is string && data.country.size() <= 50));
    }
    
    // Funﾃｧﾃ｣o poderosa que garante que campos imutﾃ｡veis nﾃ｣o foram alterados,
    // usando as funﾃｧﾃｵes nativas e corretas do Firestore.
    function areImmutableFieldsUnchanged(immutableFields) {
      // 'diff' compara os dados existentes (resource.data) com os novos (request.resource.data)
      // e retorna um conjunto de chaves que foram adicionadas, modificadas ou removidas.
      let affectedKeys = request.resource.data.diff(resource.data).affectedKeys();
      
      // A regra falha se qualquer uma das chaves afetadas estiver na lista de campos imutﾃ｡veis.
      // 'hasAny' retorna true se houver uma interseﾃｧﾃ｣o, entﾃ｣o usamos '!' para negar e permitir a escrita
      // apenas se Nﾃグ houver interseﾃｧﾃ｣o.
      return !affectedKeys.hasAny(immutableFields);
    }
  }
} 