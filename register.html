<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete seu Cadastro - Atalho</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="navbar">
            <div class="logo">
                <a href="index.html" class="logo-link">
                    <img src="assets/img/logo.svg" alt="Logo Atalho" class="logo-img" />
                    <span class="logo-text">Atalho</span>
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main style="padding-top: 100px; min-height: 100vh; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);">
        <div class="container" style="max-width: 600px; margin: 0 auto; padding: 2rem;">
            
            <!-- Status do Pagamento -->
            <div id="payment-status" style="background: white; border-radius: 12px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center;">
                <div style="color: #28a745; margin-bottom: 1rem;">
                    <i class="fas fa-check-circle" style="font-size: 3rem;"></i>
                </div>
                <h1 style="color: #28a745; margin-bottom: 1rem;">‚úÖ Pagamento Confirmado!</h1>
                <p style="color: #6c757d; margin-bottom: 1rem;">
                    Seu pagamento PIX de <strong>R$ 49,90</strong> foi aprovado com sucesso.
                </p>
                <div id="payment-details" style="background: #f8f9fa; padding: 1rem; border-radius: 6px;">
                    <p style="margin: 0; color: #6c757d;">
                        <strong>ID do Pagamento:</strong> <span id="payment-id">Carregando...</span>
                    </p>
                </div>
            </div>

            <!-- Formul√°rio de Cadastro -->
            <div id="registration-form" style="background: white; border-radius: 12px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <h2 style="color: #2c3e50; margin-bottom: 1rem; text-align: center;">
                    üìù Crie sua Conta do Atalho
                </h2>
                <p style="color: #7f8c8d; text-align: center; margin-bottom: 2rem;">
                    Complete seu cadastro para acessar sua licen√ßa e gerenciar suas configura√ß√µes
                </p>

                <form id="customer-registration-form">
                    <!-- Se√ß√£o de Login -->
                    <div style="background: #e8f4fd; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                        <h3 style="color: #0066cc; margin-bottom: 1rem; font-size: 1.1rem;">üîê Dados de Acesso</h3>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: #2c3e50; font-weight: 500;">
                                Email de Login *
                            </label>
                            <input type="email" id="login-email" required
                                   style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 6px; font-size: 1rem;"
                                   placeholder="seu@email.com">
                            <small style="color: #7f8c8d;">Este ser√° seu email de login no sistema</small>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: #2c3e50; font-weight: 500;">
                                Senha *
                            </label>
                            <input type="password" id="login-password" required minlength="6"
                                   style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 6px; font-size: 1rem;"
                                   placeholder="M√≠nimo 6 caracteres">
                            <small style="color: #7f8c8d;">Escolha uma senha segura com pelo menos 6 caracteres</small>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: #2c3e50; font-weight: 500;">
                                Confirmar Senha *
                            </label>
                            <input type="password" id="confirm-password" required minlength="6"
                                   style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 6px; font-size: 1rem;"
                                   placeholder="Digite a senha novamente">
                        </div>
                    </div>

                    <!-- Se√ß√£o de Dados Pessoais -->
                    <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                        <h3 style="color: #495057; margin-bottom: 1rem; font-size: 1.1rem;">üë§ Dados Pessoais</h3>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: #2c3e50; font-weight: 500;">
                                Nome Completo *
                            </label>
                            <input type="text" id="customer-name" required
                                   style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 6px; font-size: 1rem;"
                                   placeholder="Seu nome completo">
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: #2c3e50; font-weight: 500;">
                                Telefone (opcional)
                            </label>
                            <input type="tel" id="customer-phone"
                                   style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 6px; font-size: 1rem;"
                                   placeholder="(11) 99999-9999">
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: #2c3e50; font-weight: 500;">
                                Empresa (opcional)
                            </label>
                            <input type="text" id="customer-company"
                                   style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 6px; font-size: 1rem;"
                                   placeholder="Nome da sua empresa">
                        </div>
                    </div>

                    <!-- Se√ß√£o Adicional -->
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: #2c3e50; font-weight: 500;">
                            Como voc√™ conheceu o Atalho? (opcional)
                        </label>
                        <select id="referral-source" style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 6px; font-size: 1rem;">
                            <option value="">Selecione uma op√ß√£o</option>
                            <option value="google">Pesquisa no Google</option>
                            <option value="social">Redes Sociais</option>
                            <option value="friend">Indica√ß√£o de amigo</option>
                            <option value="youtube">YouTube</option>
                            <option value="blog">Blog/Site</option>
                            <option value="other">Outro</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 2rem;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="terms-accept" required style="margin-right: 0.5rem;">
                            <span style="color: #2c3e50;">
                                Aceito os <a href="#" style="color: #007bff;">termos de uso</a> e 
                                <a href="#" style="color: #007bff;">pol√≠tica de privacidade</a>
                            </span>
                        </label>
                    </div>

                    <button type="submit" id="complete-registration-btn"
                            style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: transform 0.2s;">
                        üöÄ Criar Conta e Ativar Licen√ßa
                    </button>
                </form>
            </div>

            <!-- Informa√ß√µes sobre a Conta -->
            <div style="background: #fff3cd; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; border-left: 4px solid #ffc107;">
                <h3 style="color: #856404; margin-bottom: 1rem;">üí° Sobre sua Conta</h3>
                <ul style="list-style: none; padding: 0; color: #856404;">
                    <li style="padding: 0.25rem 0;">üîë Use email e senha para fazer login no sistema</li>
                    <li style="padding: 0.25rem 0;">üì± Acesse de qualquer dispositivo</li>
                    <li style="padding: 0.25rem 0;">‚öôÔ∏è Gerencie suas configura√ß√µes e licen√ßas</li>
                    <li style="padding: 0.25rem 0;">üìß Receba atualiza√ß√µes e suporte</li>
                </ul>
            </div>

            <!-- Se√ß√£o de Seguran√ßa -->
            <div style="background: #e8f5e8; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; border-left: 4px solid #28a745;">
                <h3 style="color: #28a745; margin-bottom: 1rem;">üîí Seus Dados Est√£o Seguros</h3>
                <ul style="list-style: none; padding: 0; color: #6c757d;">
                    <li style="padding: 0.25rem 0;">‚úì Pagamento j√° confirmado e processado</li>
                    <li style="padding: 0.25rem 0;">‚úì Senhas criptografadas com seguran√ßa m√°xima</li>
                    <li style="padding: 0.25rem 0;">‚úì Dados protegidos por Firebase Auth</li>
                    <li style="padding: 0.25rem 0;">‚úì Acesso seguro via HTTPS</li>
                </ul>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="assets/js/firebase.js"></script>

    <script>
        // Fun√ß√£o para mostrar mensagens
        function showSuccess(message) {
            alert('‚úÖ ' + message);
        }

        function showError(message) {
            alert('‚ùå ' + message);
        }

        // Fun√ß√£o para validar senhas
        function validatePasswords() {
            const password = document.getElementById('login-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            if (password !== confirmPassword) {
                showError('As senhas n√£o coincidem.');
                return false;
            }
            
            if (password.length < 6) {
                showError('A senha deve ter pelo menos 6 caracteres.');
                return false;
            }
            
            return true;
        }

        // Fun√ß√£o para obter par√¢metros da URL
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                paymentId: urlParams.get('payment'),
                token: urlParams.get('token')
            };
        }

        // Fun√ß√£o para validar o token de registro
        async function validateRegistrationToken(paymentId, token) {
            try {
                console.log(`üîç Validando token de registro para pagamento ${paymentId}`);
                
                // Verifica no Firebase se o token √© v√°lido
                const paymentRef = db.collection('approved_payments').doc(paymentId);
                const doc = await paymentRef.get();
                
                if (!doc.exists) {
                    throw new Error('Pagamento n√£o encontrado');
                }
                
                const data = doc.data();
                
                if (data.registration_token !== token) {
                    throw new Error('Token de registro inv√°lido');
                }
                
                if (data.registration_completed) {
                    throw new Error('Cadastro j√° foi completado para este pagamento');
                }
                
                return data;
            } catch (error) {
                console.error('‚ùå Erro na valida√ß√£o:', error);
                throw error;
            }
        }

        // Fun√ß√£o para criar conta Firebase Auth
        async function createFirebaseAccount(email, password) {
            try {
                console.log('üîê Criando conta Firebase Auth...');
                
                const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                console.log('‚úÖ Conta Firebase criada:', user.uid);
                return user;
            } catch (error) {
                console.error('‚ùå Erro ao criar conta Firebase:', error);
                
                // Traduz erros comuns do Firebase
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        throw new Error('Este email j√° est√° em uso. Tente fazer login ou use outro email.');
                    case 'auth/invalid-email':
                        throw new Error('Email inv√°lido.');
                    case 'auth/weak-password':
                        throw new Error('Senha muito fraca. Use pelo menos 6 caracteres.');
                    default:
                        throw new Error('Erro ao criar conta: ' + error.message);
                }
            }
        }

        // Fun√ß√£o para completar o registro
        async function completeRegistration(paymentId, customerData, firebaseUser) {
            try {
                console.log('üíæ Completando registro para pagamento:', paymentId);
                
                // Atualiza o pagamento com os dados do cliente
                const paymentRef = db.collection('approved_payments').doc(paymentId);
                await paymentRef.update({
                    customer_data: customerData,
                    firebase_uid: firebaseUser.uid,
                    firebase_email: firebaseUser.email,
                    registration_completed: true,
                    registration_completed_at: firebase.firestore.FieldValue.serverTimestamp(),
                    awaiting_registration: false
                });
                
                // Cria registro na cole√ß√£o de clientes
                const customerRef = db.collection('customers').doc(firebaseUser.uid);
                await customerRef.set({
                    ...customerData,
                    firebase_uid: firebaseUser.uid,
                    firebase_email: firebaseUser.email,
                    payment_id: paymentId,
                    license_status: 'active',
                    license_type: 'annual',
                    license_activated_at: firebase.firestore.FieldValue.serverTimestamp(),
                    created_at: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log('‚úÖ Registro completado com sucesso!');
                return firebaseUser.uid;
            } catch (error) {
                console.error('‚ùå Erro ao completar registro:', error);
                throw error;
            }
        }

        // Inicializa√ß√£o da p√°gina
        document.addEventListener('DOMContentLoaded', async function() {
            const { paymentId, token } = getUrlParams();
            
            if (!paymentId || !token) {
                showError('Link inv√°lido. Verifique o email recebido.');
                return;
            }
            
            document.getElementById('payment-id').textContent = paymentId;
            
            try {
                // Valida o token
                const paymentData = await validateRegistrationToken(paymentId, token);
                console.log('‚úÖ Token v√°lido, pagamento encontrado:', paymentData);
                
            } catch (error) {
                showError('Link inv√°lido ou expirado: ' + error.message);
                document.getElementById('registration-form').style.display = 'none';
                return;
            }
        });

        // Manipulador do formul√°rio de registro
        document.getElementById('customer-registration-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const { paymentId, token } = getUrlParams();
            
            const loginEmail = document.getElementById('login-email').value.trim();
            const loginPassword = document.getElementById('login-password').value;
            const name = document.getElementById('customer-name').value.trim();
            const phone = document.getElementById('customer-phone').value.trim();
            const company = document.getElementById('customer-company').value.trim();
            const referralSource = document.getElementById('referral-source').value;
            const termsAccepted = document.getElementById('terms-accept').checked;

            // Valida√ß√µes
            if (!name || !loginEmail || !loginPassword) {
                showError('Por favor, preencha todos os campos obrigat√≥rios.');
                return;
            }

            if (!validatePasswords()) {
                return;
            }

            if (!termsAccepted) {
                showError('Por favor, aceite os termos de uso.');
                return;
            }

            // Valida√ß√£o b√°sica de email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(loginEmail)) {
                showError('Por favor, insira um email v√°lido.');
                return;
            }

            // Desabilita o bot√£o durante o processamento
            const btn = document.getElementById('complete-registration-btn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '‚è≥ Criando conta e ativando licen√ßa...';

            try {
                // 1. Cria conta no Firebase Auth
                const firebaseUser = await createFirebaseAccount(loginEmail, loginPassword);
                
                // 2. Prepara dados do cliente
                const customerData = {
                    name,
                    email: loginEmail,
                    phone: phone || null,
                    company: company || null,
                    referral_source: referralSource || null,
                    terms_accepted: true,
                    terms_accepted_at: new Date().toISOString()
                };

                // 3. Completa o registro no Firestore
                const customerId = await completeRegistration(paymentId, customerData, firebaseUser);
                
                // 4. Sucesso!
                showSuccess('üéâ Conta criada e licen√ßa ativada com sucesso!');
                
                // 5. Redireciona para p√°gina de dashboard
                setTimeout(() => {
                    window.location.href = `dashboard.html`;
                }, 2000);

            } catch (error) {
                console.error("Erro ao completar registro:", error);
                showError('Erro: ' + error.message);
            } finally {
                // Reabilita o bot√£o
                btn.disabled = false;
                btn.textContent = originalText;
            }
        });

        // Valida√ß√£o em tempo real das senhas
        document.getElementById('confirm-password').addEventListener('input', function() {
            const password = document.getElementById('login-password').value;
            const confirmPassword = this.value;
            
            if (confirmPassword && password !== confirmPassword) {
                this.style.borderColor = '#dc3545';
            } else {
                this.style.borderColor = '#e9ecef';
            }
        });

        // Efeito hover no bot√£o
        document.getElementById('complete-registration-btn').addEventListener('mouseenter', function() {
            if (!this.disabled) {
                this.style.transform = 'translateY(-2px)';
            }
        });

        document.getElementById('complete-registration-btn').addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });

        console.log("üöÄ P√°gina de registro com autentica√ß√£o carregada");
    </script>
</body>

</html> 