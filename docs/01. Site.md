# Guia Completo: Integra√ß√£o Stripe + Sistema de Licenciamento

## üìã Vis√£o Geral

Este documento detalha a implementa√ß√£o completa do sistema Stripe no site de vendas do Atalho, incluindo:
- Integra√ß√£o com o sistema de licenciamento existente (PIX + Stripe)
- Configura√ß√£o de produtos e assinaturas
- Webhooks para renova√ß√£o autom√°tica
- APIs para comunica√ß√£o com o Firebase
- Fluxo completo de compra e ativa√ß√£o

---

## üéØ Objetivos

- **Manter PIX existente** como op√ß√£o de pagamento
- **Adicionar Stripe** para cart√£o de cr√©dito e assinaturas
- **Unificar licenciamento** (ambos os m√©todos ativam a mesma estrutura)
- **Renova√ß√£o autom√°tica** via Stripe (opcional para o usu√°rio)
- **Comunica√ß√£o direta** com Firebase Cloud Functions

---

## üèóÔ∏è Arquitetura do Sistema

```
Site de Vendas (Frontend + Backend)
‚îú‚îÄ‚îÄ PIX (Existing) ‚Üí Manual License Activation
‚îú‚îÄ‚îÄ Stripe (New) ‚Üí Automatic License Activation
‚îî‚îÄ‚îÄ Firebase Cloud Functions
    ‚îú‚îÄ‚îÄ renewLicense() - Ativa licen√ßas
    ‚îú‚îÄ‚îÄ stripeWebhook() - Processa renova√ß√µes autom√°ticas
    ‚îî‚îÄ‚îÄ activateTrial() - Sistema de trial (j√° implementado)
```

---

## üõ†Ô∏è PARTE 1: Configura√ß√£o do Stripe Dashboard

### 1.1 Criar Conta e Configurar Stripe

1. **Acesse:** https://dashboard.stripe.com
2. **Configure empresa:** Nome, endere√ßo, dados fiscais
3. **Ative modo de produ√ß√£o** quando estiver pronto

### 1.2 Criar Produtos no Stripe

**Produto 1: Atalho - Licen√ßa Anual**
```json
{
  "name": "Atalho - Licen√ßa Anual",
  "description": "Acesso completo ao Atalho por 12 meses com renova√ß√£o autom√°tica opcional",
  "price": "R$ 79,00", // Ajuste conforme seu pre√ßo
  "billing": {
    "interval": "year",
    "interval_count": 1
  },
  "metadata": {
    "license_type": "anual",
    "product_id": "atalho_anual"
  }
}
```

**Produto 2: Atalho - Licen√ßa Vital√≠cia**
```json
{
  "name": "Atalho - Licen√ßa Vital√≠cia",
  "description": "Acesso vital√≠cio ao Atalho - pagamento √∫nico",
  "price": "R$ 299,00", // Ajuste conforme seu pre√ßo
  "billing": "one_time",
  "metadata": {
    "license_type": "vitalicia",
    "product_id": "atalho_vitalicia"
  }
}
```

### 1.3 Configurar Webhook

1. **Acesse:** Developers > Webhooks > Add endpoint
2. **URL:** `https://us-east1-shortcut-6256b.cloudfunctions.net/stripeWebhook`
3. **Eventos para escutar:**
   ```
   invoice.payment_succeeded
   customer.subscription.deleted
   customer.subscription.updated
   customer.subscription.created
   checkout.session.completed
   ```
4. **Copie o Webhook Secret** (whsec_...) - voc√™ precisar√° dele depois

---

## üíª PARTE 2: Backend do Site

### 2.1 Instalar Depend√™ncias

**Para Node.js:**
```bash
npm install stripe express cors dotenv
```

**Para PHP:**
```bash
composer require stripe/stripe-php
```

**Para Python:**
```bash
pip install stripe flask python-dotenv requests
```

### 2.2 Configurar Vari√°veis de Ambiente

**Arquivo: `.env`**
```env
# Stripe Keys
STRIPE_PUBLIC_KEY=pk_live_... # ou pk_test_ para teste
STRIPE_SECRET_KEY=sk_live_... # ou sk_test_ para teste
STRIPE_WEBHOOK_SECRET=whsec_...

# Firebase
FIREBASE_PROJECT_ID=shortcut-6256b
FIREBASE_FUNCTIONS_URL=https://us-east1-shortcut-6256b.cloudfunctions.net

# Site URLs
SITE_URL=https://atalho.me
SUCCESS_URL=https://atalho.me/success
CANCEL_URL=https://atalho.me/cancel
```

### 2.3 Implementa√ß√£o Backend (Node.js)

**Arquivo: `server.js` ou `routes/stripe.js`**

```javascript
const express = require('express');
const stripe = require('stripe')(process.env.STRIPE_SECRET_KEY);
const cors = require('cors');
const axios = require('axios');

const app = express();
app.use(cors());

// Para webhook - RAW body
app.use('/webhook/stripe', express.raw({ type: 'application/json' }));
// Para outras rotas - JSON
app.use(express.json());

// =================== CRIAR SESS√ÉO DE CHECKOUT ===================
app.post('/create-checkout-session', async (req, res) => {
  try {
    const { license_type, user_email, user_name = '' } = req.body;

    // Validar entrada
    if (!license_type || !['anual', 'vitalicia'].includes(license_type)) {
      return res.status(400).json({ error: 'Tipo de licen√ßa inv√°lido' });
    }
    if (!user_email || !user_email.includes('@')) {
      return res.status(400).json({ error: 'Email inv√°lido' });
    }

    // Configurar produto baseado no tipo
    let priceId, mode;
    if (license_type === 'anual') {
      priceId = 'price_anual_id'; // Substitua pelo ID real do Stripe
      mode = 'subscription';
    } else { // vitalicia
      priceId = 'price_vitalicia_id'; // Substitua pelo ID real do Stripe
      mode = 'payment';
    }

    // Criar ou buscar cliente
    let customer;
    const existingCustomers = await stripe.customers.list({
      email: user_email,
      limit: 1
    });

    if (existingCustomers.data.length > 0) {
      customer = existingCustomers.data[0];
    } else {
      customer = await stripe.customers.create({
        email: user_email,
        name: user_name,
        metadata: {
          source: 'atalho_website'
        }
      });
    }

    // Criar sess√£o de checkout
    const session = await stripe.checkout.sessions.create({
      customer: customer.id,
      payment_method_types: ['card'],
      line_items: [{
        price: priceId,
        quantity: 1,
      }],
      mode: mode,
      success_url: `${process.env.SUCCESS_URL}?session_id={CHECKOUT_SESSION_ID}`,
      cancel_url: process.env.CANCEL_URL,
      
      // Metadados importantes para o webhook
      metadata: {
        license_type: license_type,
        user_email: user_email,
        user_name: user_name
      },

      // Para assinaturas, configurar trial e configura√ß√µes
      ...(mode === 'subscription' && {
        subscription_data: {
          metadata: {
            license_type: license_type,
            user_email: user_email
          }
        }
      }),

      // Configura√ß√µes de pagamento
      payment_intent_data: mode === 'payment' ? {
        metadata: {
          license_type: license_type,
          user_email: user_email
        }
      } : undefined,

      // Permitir c√≥digos promocionais
      allow_promotion_codes: true,

      // Configura√ß√µes de cobran√ßa
      billing_address_collection: 'required',
      
      // Para assinaturas anuais, mostrar informa√ß√µes claras
      ...(license_type === 'anual' && {
        consent_collection: {
          terms_of_service: 'required'
        }
      })
    });

    console.log(`[CHECKOUT] Sess√£o criada para ${user_email}: ${session.id}`);
    
    res.json({ 
      id: session.id,
      url: session.url 
    });

  } catch (error) {
    console.error('[CHECKOUT] Erro ao criar sess√£o:', error);
    res.status(500).json({ 
      error: 'Erro interno do servidor',
      message: error.message 
    });
  }
});

// =================== PROCESSAR SUCESSO ===================
app.get('/success', async (req, res) => {
  try {
    const sessionId = req.query.session_id;
    
    if (!sessionId) {
      return res.status(400).json({ error: 'Session ID n√£o fornecido' });
    }

    // Buscar sess√£o no Stripe
    const session = await stripe.checkout.sessions.retrieve(sessionId, {
      expand: ['customer', 'subscription', 'payment_intent']
    });

    console.log(`[SUCCESS] Processando sucesso para sess√£o: ${sessionId}`);

    // Preparar dados para ativa√ß√£o da licen√ßa
    const licenseData = {
      license_type: session.metadata.license_type,
      stripe_customer_id: session.customer.id,
      user_email: session.metadata.user_email
    };

    // Se for assinatura, adicionar subscription_id
    if (session.subscription) {
      licenseData.stripe_subscription_id = session.subscription.id;
    }

    // Chamar Firebase Cloud Function para ativar licen√ßa
    const licenseResult = await activateUserLicense(licenseData);

    if (licenseResult.success) {
      console.log(`[SUCCESS] Licen√ßa ativada com sucesso para ${licenseData.user_email}`);
      
      // Redirecionar para p√°gina de sucesso com informa√ß√µes
      res.redirect(`/success-page?license=${licenseData.license_type}&email=${encodeURIComponent(licenseData.user_email)}`);
    } else {
      console.error(`[SUCCESS] Erro ao ativar licen√ßa:`, licenseResult);
      res.redirect(`/error-page?reason=license_activation_failed`);
    }

  } catch (error) {
    console.error('[SUCCESS] Erro ao processar sucesso:', error);
    res.redirect('/error-page?reason=processing_error');
  }
});

// =================== WEBHOOK DO STRIPE ===================
app.post('/webhook/stripe', async (req, res) => {
  const sig = req.headers['stripe-signature'];
  let event;

  try {
    // Verificar assinatura do webhook
    event = stripe.webhooks.constructEvent(
      req.body, 
      sig, 
      process.env.STRIPE_WEBHOOK_SECRET
    );
  } catch (err) {
    console.error(`[WEBHOOK] Erro na verifica√ß√£o: ${err.message}`);
    return res.status(400).send(`Webhook Error: ${err.message}`);
  }

  console.log(`[WEBHOOK] Evento recebido: ${event.type}`);

  try {
    switch (event.type) {
      case 'checkout.session.completed':
        await handleCheckoutCompleted(event.data.object);
        break;
        
      case 'invoice.payment_succeeded':
        await handlePaymentSucceeded(event.data.object);
        break;
        
      case 'customer.subscription.deleted':
        await handleSubscriptionDeleted(event.data.object);
        break;
        
      case 'customer.subscription.updated':
        await handleSubscriptionUpdated(event.data.object);
        break;
        
      default:
        console.log(`[WEBHOOK] Evento n√£o tratado: ${event.type}`);
    }

    res.json({ received: true });
  } catch (error) {
    console.error(`[WEBHOOK] Erro ao processar evento ${event.type}:`, error);
    res.status(500).json({ error: 'Erro interno' });
  }
});

// =================== FUN√á√ïES AUXILIARES ===================

async function activateUserLicense(licenseData) {
  try {
    console.log(`[FIREBASE] Ativando licen√ßa para ${licenseData.user_email}`);
    
    const response = await axios.post(
      `${process.env.FIREBASE_FUNCTIONS_URL}/renewLicense`,
      {
        data: licenseData
      },
      {
        headers: {
          'Content-Type': 'application/json'
        },
        timeout: 30000
      }
    );

    if (response.status === 200 && response.data.result) {
      return response.data.result;
    } else {
      throw new Error(`Resposta inesperada: ${response.status}`);
    }
  } catch (error) {
    console.error('[FIREBASE] Erro ao ativar licen√ßa:', error);
    return {
      success: false,
      error: 'FIREBASE_ERROR',
      message: error.message
    };
  }
}

async function handleCheckoutCompleted(session) {
  console.log(`[WEBHOOK] Checkout completado: ${session.id}`);
  
  // Para pagamentos √∫nicos (licen√ßa vital√≠cia), ativar imediatamente
  if (session.mode === 'payment') {
    const licenseData = {
      license_type: session.metadata.license_type,
      stripe_customer_id: session.customer,
      user_email: session.metadata.user_email
    };
    
    await activateUserLicense(licenseData);
  }
  
  // Para assinaturas, a ativa√ß√£o acontece no invoice.payment_succeeded
}

async function handlePaymentSucceeded(invoice) {
  console.log(`[WEBHOOK] Pagamento bem-sucedido: ${invoice.id}`);
  
  // Para renova√ß√µes autom√°ticas de assinatura
  if (invoice.subscription) {
    // O Firebase Cloud Function j√° processa isso automaticamente
    // Aqui podemos adicionar logs ou notifica√ß√µes adicionais
    console.log(`[WEBHOOK] Renova√ß√£o autom√°tica processada para subscription: ${invoice.subscription}`);
  }
}

async function handleSubscriptionDeleted(subscription) {
  console.log(`[WEBHOOK] Assinatura cancelada: ${subscription.id}`);
  
  // O Firebase Cloud Function j√° processa isso automaticamente
  // Aqui podemos adicionar logs ou enviar emails de feedback
}

async function handleSubscriptionUpdated(subscription) {
  console.log(`[WEBHOOK] Assinatura atualizada: ${subscription.id}`);
  
  // Tratar mudan√ßas de plano, pausas, etc.
  // Implementar conforme necess√°rio
}

// Iniciar servidor
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`[SERVER] Rodando na porta ${PORT}`);
});
```

---

## üé® PARTE 3: Frontend do Site

### 3.1 Incluir Stripe.js

**No HTML:**
```html
<script src="https://js.stripe.com/v3/"></script>
```

### 3.2 P√°gina de Pre√ßos

**Arquivo: `pricing.html` ou equivalente**

```html
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atalho - Planos e Pre√ßos</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        .pricing-container {
            display: flex;
            gap: 2rem;
            justify-content: center;
            padding: 2rem;
        }
        .pricing-card {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            min-width: 300px;
        }
        .pricing-card.popular {
            border-color: #007bff;
            transform: scale(1.05);
        }
        .price {
            font-size: 2.5rem;
            font-weight: bold;
            color: #007bff;
        }
        .payment-methods {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-secondary {
            background-color: #28a745;
            color: white;
        }
        .trial-banner {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: white;
            padding: 1rem;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
    <!-- Banner do Trial -->
    <div class="trial-banner">
        <h2>üéâ Teste Gr√°tis por 7 Dias!</h2>
        <p>Fa√ßa download do app e teste todas as funcionalidades sem compromisso.</p>
        <a href="/download" class="btn btn-primary">Baixar e Testar Gr√°tis</a>
    </div>

    <!-- Planos de Pre√ßos -->
    <div class="pricing-container">
        <!-- Plano Anual -->
        <div class="pricing-card popular">
            <h3>Licen√ßa Anual</h3>
            <div class="price">R$ 79</div>
            <p>Por ano ‚Ä¢ Renova√ß√£o autom√°tica opcional</p>
            
            <ul style="text-align: left; margin: 1.5rem 0;">
                <li>‚úÖ Acesso completo a todas as funcionalidades</li>
                <li>‚úÖ Atualiza√ß√µes autom√°ticas</li>
                <li>‚úÖ Suporte priorit√°rio</li>
                <li>‚úÖ Renova√ß√£o autom√°tica (pode cancelar a qualquer momento)</li>
                <li>‚úÖ Garantia de 30 dias</li>
            </ul>

            <div class="payment-methods">
                <button class="btn btn-primary" onclick="buyWithStripe('anual')">
                    üí≥ Cart√£o de Cr√©dito
                </button>
                <a href="/pix?plan=anual" class="btn btn-secondary">
                    üè¶ PIX
                </a>
            </div>
        </div>

        <!-- Plano Vital√≠cio -->
        <div class="pricing-card">
            <h3>Licen√ßa Vital√≠cia</h3>
            <div class="price">R$ 299</div>
            <p>Pagamento √∫nico ‚Ä¢ Para sempre</p>
            
            <ul style="text-align: left; margin: 1.5rem 0;">
                <li>‚úÖ Tudo do plano anual</li>
                <li>‚úÖ Acesso vital√≠cio</li>
                <li>‚úÖ Sem renova√ß√µes</li>
                <li>‚úÖ Melhor custo-benef√≠cio</li>
                <li>‚úÖ Investimento √∫nico</li>
            </ul>

            <div class="payment-methods">
                <button class="btn btn-primary" onclick="buyWithStripe('vitalicia')">
                    üí≥ Cart√£o de Cr√©dito
                </button>
                <a href="/pix?plan=vitalicia" class="btn btn-secondary">
                    üè¶ PIX
                </a>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Inicializar Stripe
        const stripe = Stripe('pk_live_...'); // Substitua pela sua chave p√∫blica

        // Fun√ß√£o para comprar com Stripe
        async function buyWithStripe(licenseType) {
            try {
                // Desabilitar bot√£o temporariamente
                event.target.disabled = true;
                event.target.textContent = 'Processando...';

                // Criar sess√£o de checkout
                const response = await fetch('/create-checkout-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        license_type: licenseType,
                        user_email: getUserEmail(), // Implementar esta fun√ß√£o
                        user_name: getUserName()    // Implementar esta fun√ß√£o
                    })
                });

                if (!response.ok) {
                    throw new Error('Erro ao criar sess√£o de pagamento');
                }

                const session = await response.json();

                // Redirecionar para o Stripe Checkout
                const result = await stripe.redirectToCheckout({
                    sessionId: session.id
                });

                if (result.error) {
                    alert('Erro: ' + result.error.message);
                }

            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao processar pagamento. Tente novamente.');
            } finally {
                // Reabilitar bot√£o
                event.target.disabled = false;
                event.target.textContent = 'üí≥ Cart√£o de Cr√©dito';
            }
        }

        // Fun√ß√µes auxiliares - implementar conforme seu sistema
        function getUserEmail() {
            // Retornar email do usu√°rio logado ou solicitar
            return prompt('Digite seu email:') || '';
        }

        function getUserName() {
            // Retornar nome do usu√°rio logado ou solicitar
            return prompt('Digite seu nome:') || '';
        }
    </script>
</body>
</html>
```

### 3.3 P√°ginas de Resultado

**Arquivo: `success.html`**
```html
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compra Realizada com Sucesso - Atalho</title>
    <style>
        .success-container {
            max-width: 600px;
            margin: 2rem auto;
            padding: 2rem;
            text-align: center;
            border: 2px solid #28a745;
            border-radius: 12px;
            background-color: #f8fff9;
        }
        .success-icon {
            font-size: 4rem;
            color: #28a745;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="success-container">
        <div class="success-icon">‚úÖ</div>
        <h1>Pagamento Realizado com Sucesso!</h1>
        <p>Sua licen√ßa foi ativada automaticamente.</p>
        
        <div id="license-info">
            <!-- Informa√ß√µes da licen√ßa ser√£o preenchidas via JavaScript -->
        </div>

        <div style="margin-top: 2rem;">
            <a href="/download" class="btn btn-primary">Baixar o Atalho</a>
            <a href="/account" class="btn btn-secondary">Minha Conta</a>
        </div>

        <div style="margin-top: 2rem; padding: 1rem; background-color: #e9ecef; border-radius: 6px;">
            <h3>üìß Pr√≥ximos Passos:</h3>
            <ol style="text-align: left;">
                <li>Baixe o aplicativo Atalho</li>
                <li>Fa√ßa login com o email usado na compra</li>
                <li>Comece a usar todas as funcionalidades!</li>
            </ol>
        </div>
    </div>

    <script>
        // Extrair informa√ß√µes da URL
        const urlParams = new URLSearchParams(window.location.search);
        const licenseType = urlParams.get('license');
        const userEmail = urlParams.get('email');

        // Preencher informa√ß√µes da licen√ßa
        if (licenseType && userEmail) {
            document.getElementById('license-info').innerHTML = `
                <div style="margin: 1rem 0; padding: 1rem; background-color: white; border-radius: 6px;">
                    <p><strong>Tipo de Licen√ßa:</strong> ${licenseType === 'anual' ? 'Anual' : 'Vital√≠cia'}</p>
                    <p><strong>Email:</strong> ${decodeURIComponent(userEmail)}</p>
                    <p><strong>Status:</strong> <span style="color: #28a745;">Ativa</span></p>
                </div>
            `;
        }
    </script>
</body>
</html>
```

---

## üîß PARTE 4: Configura√ß√£o Final

### 4.1 Configurar Secret no Firebase

**Depois de obter o Webhook Secret do Stripe:**

```bash
cd functions
firebase functions:secrets:set STRIPE_WEBHOOK_SECRET
# Cole o valor whsec_... quando solicitado
```

**Descomentar no `functions/index.js`:**
```javascript
exports.stripeWebhook = onRequest({
    cors: true,
    secrets: ["STRIPE_WEBHOOK_SECRET"] // Descomentar esta linha
}, async (req, res) => {
```

**Fazer novo deploy:**
```bash
firebase deploy --only functions
```

### 4.2 IDs dos Produtos

**Ap√≥s criar os produtos no Stripe, atualizar no c√≥digo:**

```javascript
// No arquivo server.js, substituir:
let priceId, mode;
if (license_type === 'anual') {
  priceId = 'price_1234567890'; // ID real do produto anual
  mode = 'subscription';
} else { // vitalicia
  priceId = 'price_0987654321'; // ID real do produto vital√≠cio
  mode = 'payment';
}
```

### 4.3 Configurar Dom√≠nios no Stripe

**No Stripe Dashboard:**
1. Settings > Business settings > Public business information
2. Adicionar seu dom√≠nio principal: `atalho.me`
3. Em Checkout settings, adicionar dom√≠nios permitidos

---

## üìä PARTE 5: Monitoramento e Logs

### 5.1 Logs do Firebase

**Visualizar logs das Cloud Functions:**
```bash
firebase functions:log
```

**Logs espec√≠ficos:**
```bash
firebase functions:log --only activateTrial
firebase functions:log --only renewLicense
firebase functions:log --only stripeWebhook
```

### 5.2 Dashboard do Stripe

**Acessar regularmente:**
- **Payments:** Ver transa√ß√µes em tempo real
- **Subscriptions:** Gerenciar assinaturas ativas
- **Webhooks:** Verificar status e reprocessar se necess√°rio
- **Logs:** Debugar problemas de webhook

### 5.3 Firestore Database

**Monitorar cole√ß√£o `users`:**
- Verificar se licen√ßas est√£o sendo ativadas corretamente
- Acompanhar `renewal_count` para estat√≠sticas
- Verificar `auto_renewal_enabled` para assinaturas

---

## üß™ PARTE 6: Testes

### 6.1 Usar Modo de Teste do Stripe

**Chaves de teste:**
```env
STRIPE_PUBLIC_KEY=pk_test_...
STRIPE_SECRET_KEY=sk_test_...
```

**Cart√µes de teste:**
```
Sucesso: 4242 4242 4242 4242
Falha: 4000 0000 0000 0002
3D Secure: 4000 0027 6000 3184
```

### 6.2 Testar Fluxo Completo

1. **Registro:** Criar conta no app
2. **Trial:** Verificar se ativa automaticamente
3. **Compra Stripe:** Testar checkout completo
4. **Ativa√ß√£o:** Verificar se licen√ßa √© ativada
5. **Renova√ß√£o:** Testar webhook de renova√ß√£o

### 6.3 Testar Webhooks

**Usar Stripe CLI para teste local:**
```bash
stripe listen --forward-to localhost:3000/webhook/stripe
stripe trigger invoice.payment_succeeded
```

---

## üö® PARTE 7: Tratamento de Erros

### 7.1 Erros Comuns

**Webhook n√£o funcionando:**
- Verificar URL e secret
- Verificar logs no Stripe Dashboard
- Testar endpoint manualmente

**Licen√ßa n√£o ativando:**
- Verificar logs do Firebase
- Verificar se email existe no Firestore
- Testar Cloud Function diretamente

**Pagamento aceito mas licen√ßa n√£o ativa:**
- Verificar webhook events
- Reprocessar webhook manualmente
- Ativar licen√ßa manualmente via Firebase Console

### 7.2 Backup Manual

**Para ativar licen√ßa manualmente via Firebase Console:**
```javascript
// No Firestore, documento do usu√°rio:
{
  license_active: true,
  license_type: "anual", // ou "vitalicia"
  sub_start: new Date(),
  sub_end: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000), // +1 ano
  payment_status: "paid",
  stripe_customer_id: "cus_...", // do Stripe
  renewal_count: 1,
  updated_at: new Date().toISOString()
}
```

---

## üìã PARTE 8: Checklist de Implanta√ß√£o

### 8.1 Antes de Produ√ß√£o

- [ ] Testar todos os fluxos em modo sandbox
- [ ] Configurar webhook em produ√ß√£o
- [ ] Adicionar secret no Firebase
- [ ] Testar renova√ß√£o autom√°tica
- [ ] Configurar monitoramento de logs
- [ ] Preparar suporte para d√∫vidas de pagamento

### 8.2 P√≥s-Implanta√ß√£o

- [ ] Monitorar primeiras transa√ß√µes
- [ ] Verificar se webhooks est√£o chegando
- [ ] Acompanhar ativa√ß√µes de licen√ßa
- [ ] Coletar feedback dos usu√°rios
- [ ] Ajustar pre√ßos se necess√°rio

---

## üí° PARTE 9: Dicas Importantes

### 9.1 Experi√™ncia do Usu√°rio

- **Trial primeiro:** Sempre ofere√ßa trial antes da compra
- **PIX mantido:** Muitos brasileiros preferem PIX
- **Transpar√™ncia:** Deixe claro que √© renova√ß√£o autom√°tica
- **F√°cil cancelamento:** Forne√ßa links claros para cancelar

### 9.2 Otimiza√ß√µes

- **C√≥digos promocionais:** Use o sistema do Stripe
- **A/B testing:** Teste diferentes pre√ßos e ofertas
- **Remarketing:** Configure pixels para remarketing
- **Analytics:** Acompanhe funil de convers√£o

### 9.3 Suporte

- **FAQ:** Prepare FAQ sobre renova√ß√£o autom√°tica
- **Suporte:** Treine equipe para d√∫vidas sobre Stripe
- **Reembolsos:** Defina pol√≠tica clara de reembolsos
- **Cancelamentos:** Processo claro via Stripe Customer Portal

---

## üéØ RESUMO EXECUTIVO

**O que este guia implementa:**

1. ‚úÖ **Sistema h√≠brido PIX + Stripe** 
2. ‚úÖ **Ativa√ß√£o autom√°tica de licen√ßas**
3. ‚úÖ **Renova√ß√£o autom√°tica via Stripe**
4. ‚úÖ **Trial gratuito de 7 dias**
5. ‚úÖ **Integra√ß√£o completa com Firebase**
6. ‚úÖ **Monitoramento e logs detalhados**

**Benef√≠cios:**
- Reduz atrito para compras internacionais
- Automatiza renova√ß√µes (menos churns)
- Mant√©m op√ß√£o PIX para p√∫blico brasileiro
- Sistema robusto de trial para aquisi√ß√£o
- Escal√°vel para crescimento futuro

---

*Documento criado para implementa√ß√£o completa do sistema Stripe + licenciamento no site do Atalho. Siga os passos em ordem e teste cada etapa antes de seguir para a pr√≥xima.*