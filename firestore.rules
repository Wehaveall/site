rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // =====================================
    // 游 REGRAS PARA COLE칂츾O DE USU츼RIOS
    // =====================================
    
    match /users/{userId} {
      // Usu치rios podem apenas ler seus pr칩prios documentos
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // Escrita apenas com valida칞칚o (CORRIGIDO: removida regra duplicada)
      allow create, update: if request.auth != null 
                           && request.auth.uid == userId
                           && validateUserData(request.resource.data);
    }
    
    // =====================================
    // 游 REGRAS PARA COLE칂츾O DE EMAIL
    // =====================================
    
    match /mail/{emailId} {
      // Apenas o sistema pode escrever emails (via Admin SDK)
      // Usu치rios n칚o podem ler ou escrever emails diretamente
      allow read, write: if false;
    }
    
    // =====================================
    // 游 REGRAS PARA OUTRAS COLE칂칏ES
    // =====================================
    
    // Qualquer outra cole칞칚o n칚o especificada 칠 bloqueada por padr칚o
    match /{document=**} {
      allow read, write: if false;
    }
    
    // =====================================
    // 游댢 FUN칂칏ES DE VALIDA칂츾O
    // =====================================
    
    function validateUserData(data) {
      // Validar campos obrigat칩rios
      return data.keys().hasAll(['Nome', 'email', 'created_at'])
      
      // Validar tipos de dados
      && data.Nome is string
      && data.email is string
      && data.email.matches('.*@.*\\..*') // Formato b치sico de email
      
      // Validar tamanhos
      && data.Nome.size() > 0 && data.Nome.size() <= 100
      && data.email.size() > 0 && data.email.size() <= 255
      
      // Validar campos opcionais se presentes
      && (data.phone == null || (data.phone is string && data.phone.size() <= 20))
      && (data.country == null || (data.country is string && data.country.size() <= 50))
      
      // Validar que UID corresponde ao documento (CORRIGIDO: suporte para cria칞칚o)
      && data.id == userId
      
      // Validar que o email no documento corresponde ao email do usu치rio autenticado
      && data.email == request.auth.token.email;
    }
  }
} 